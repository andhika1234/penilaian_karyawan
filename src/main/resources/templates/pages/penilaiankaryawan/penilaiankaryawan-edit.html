<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/master}">
<head>
    <title>Edit Penilaian Karyawan</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
        }
        .progress-soft {
            background-color: rgba(0,0,0,0.05);
        }
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .gap-2 {
            gap: 0.5rem;
        }
        /* Select2 validation styling */
        .select2-container.is-invalid + .select2-container--bootstrap-5 .select2-selection {
            border-color: #dc3545;
        }
        .is-invalid + .select2-container--bootstrap-5 .select2-selection {
            border-color: #dc3545;
        }
        .select2-container--bootstrap-5 .select2-selection--single {
            padding: 0.375rem 0.75rem;
        }
        /* Star Rating Styles */
        .star-rating {
            font-size: 2rem;
            cursor: pointer;
            user-select: none;
        }
        .star-rating .star {
            color: #ddd;
            transition: color 0.2s ease;
            margin-right: 0.25rem;
        }
        .star-rating .star:hover,
        .star-rating .star.hover {
            color: #ffc107;
        }
        .star-rating .star.filled {
            color: #ffc107;
        }
        .kriteria-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #fff;
        }
        .kriteria-item:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        .rating-value {
            font-size: 0.875rem;
            min-width: 50px;
            text-align: center;
        }
    </style>
</head>

<th:block layout:fragment="content">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <a th:href="@{/penilaiankaryawan}" class="btn btn-secondary">
                        <i class="ti ti-arrow-left me-1"></i>
                        Kembali
                    </a>
                </div>
                <h4 class="page-title">Edit Penilaian Karyawan</h4>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title mb-4">Form Edit Penilaian Karyawan</h4>

                    <form id="formPenilaian" th:action="@{/penilaiankaryawan/update}" method="post">
                        <input type="hidden" id="id" name="id" th:value="${penilaian?.id}">

                        <div class="row">
                            <!-- Pilih Bulan dan Tahun -->
                            <div class="col-md-6 mb-3">
                                <label for="bulan" class="form-label">Bulan <span class="text-danger">*</span></label>
                                <select class="form-control" id="bulan" name="bulan" required>
                                    <option value="">Pilih Bulan</option>
                                    <option value="1" th:selected="${penilaian?.bulan == 1}">Januari</option>
                                    <option value="2" th:selected="${penilaian?.bulan == 2}">Februari</option>
                                    <option value="3" th:selected="${penilaian?.bulan == 3}">Maret</option>
                                    <option value="4" th:selected="${penilaian?.bulan == 4}">April</option>
                                    <option value="5" th:selected="${penilaian?.bulan == 5}">Mei</option>
                                    <option value="6" th:selected="${penilaian?.bulan == 6}">Juni</option>
                                    <option value="7" th:selected="${penilaian?.bulan == 7}">Juli</option>
                                    <option value="8" th:selected="${penilaian?.bulan == 8}">Agustus</option>
                                    <option value="9" th:selected="${penilaian?.bulan == 9}">September</option>
                                    <option value="10" th:selected="${penilaian?.bulan == 10}">Oktober</option>
                                    <option value="11" th:selected="${penilaian?.bulan == 11}">November</option>
                                    <option value="12" th:selected="${penilaian?.bulan == 12}">Desember</option>
                                </select>
                                <div class="invalid-feedback">
                                    Bulan wajib dipilih
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="tahun" class="form-label">Tahun <span class="text-danger">*</span></label>
                                <select class="form-control" id="tahun" name="tahun" required>
                                    <option value="">Pilih Tahun</option>
                                </select>
                                <div class="invalid-feedback">
                                    Tahun wajib dipilih
                                </div>
                            </div>

                            <!-- Pilih Divisi -->
                            <div class="col-md-6 mb-3">
                                <label for="divisi" class="form-label">Divisi <span class="text-danger">*</span></label>
                                <select class="form-control select2"
                                        id="divisi"
                                        name="divisiId"
                                        data-placeholder="Pilih Divisi"
                                        required>
                                    <option value=""></option>
                                    <option th:each="divisi : ${divisiList}"
                                            th:value="${divisi.id}"
                                            th:text="${divisi.namaDivisi}"
                                            th:selected="${penilaian.divisi != null && penilaian.divisi.id == divisi.id}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Divisi wajib dipilih
                                </div>
                            </div>

                            <!-- Nama Karyawan -->
                            <div class="col-md-6 mb-3">
                                <label for="namaKaryawan" class="form-label">Nama Karyawan <span class="text-danger">*</span></label>
                                <select class="form-control select2"
                                        id="namaKaryawan"
                                        name="karyawanId"
                                        data-placeholder="Pilih Karyawan"
                                        required>
                                    <option value=""></option>
                                    <option th:each="karyawan : ${karyawanList}"
                                            th:value="${karyawan.id}"
                                            th:text="${karyawan.namaKaryawan}"
                                            th:selected="${penilaian.karyawan != null && penilaian.karyawan.id == karyawan.id}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Nama karyawan wajib dipilih
                                </div>
                            </div>

                            <!-- Jabatan -->
                            <div class="col-md-12 mb-3">
                                <label for="jabatan" class="form-label">Jabatan <span class="text-danger">*</span></label>
                                <select class="form-control select2"
                                        id="jabatan"
                                        name="jabatanId"
                                        data-placeholder="Pilih Jabatan"
                                        required>
                                    <option value=""></option>
                                    <option th:each="jabatan : ${jabatanList}"
                                            th:value="${jabatan.id}"
                                            th:text="${jabatan.namaJabatan}"
                                            th:selected="${penilaian.jabatan != null && penilaian.jabatan.id == jabatan.id}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Jabatan wajib dipilih
                                </div>
                            </div>

                            <!-- Rating Penilaian per Kriteria -->
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Rating Penilaian <span class="text-danger">*</span></label>
                                <div class="card">
                                    <div class="card-body">
                                        <small class="text-muted mb-3 d-block">Klik bintang untuk memberikan penilaian (1-5 bintang)</small>

                                        <div id="kriteriaContainer">
                                            <!-- Kriteria dimuat dinamis dari database -->
                                            <div th:each="kriteria : ${kriteriaList}" class="kriteria-item mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <strong th:text="${kriteria.namaKriteria}">Nama Kriteria</strong>
                                                    <span class="badge bg-secondary rating-value">0/5</span>
                                                </div>
                                                <div class="star-rating" th:attr="data-kriteria=${kriteria.namaKriteria}">
                                                    <i class="ti ti-star star" data-value="1"></i>
                                                    <i class="ti ti-star star" data-value="2"></i>
                                                    <i class="ti ti-star star" data-value="3"></i>
                                                    <i class="ti ti-star star" data-value="4"></i>
                                                    <i class="ti ti-star star" data-value="5"></i>
                                                </div>
                                                <input type="hidden"
                                                       th:name="'kriteria[' + ${kriteria.namaKriteria} + ']'"
                                                       class="rating-input"
                                                       th:attr="data-value=${penilaian.getNilaiByKriteria(kriteria.namaKriteria)}">
                                            </div>
                                        </div>

                                        <div class="mt-3 p-3 bg-light rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>Rata-rata Penilaian:</strong>
                                                <h4 class="mb-0" id="averageRating">0.0 / 5.0</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="invalid-feedback" id="ratingError" style="display: none;">
                                    Semua kriteria wajib dinilai
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a th:href="@{/penilaiankaryawan}" class="btn btn-secondary">
                                        <i class="ti ti-x me-1"></i>
                                        Batal
                                    </a>
                                    <button type="reset" class="btn btn-warning">
                                        <i class="ti ti-refresh me-1"></i>
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="ti ti-device-floppy me-1"></i>
                                        Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="page_js">
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function() {
            // Get values from Thymeleaf
            var bulanValue = /*[[${penilaian?.bulan}]]*/ null;
            var tahunValue = /*[[${penilaian?.tahun}]]*/ null;

            // Populate year dropdown
            const currentYear = new Date().getFullYear();
            const $tahunSelect = $('#tahun');

            // Populate year dropdown (current year - 5 to current year + 2)
            for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                const selected = (tahunValue && tahunValue == year) ? 'selected' : '';
                $tahunSelect.append(new Option(year, year, false, tahunValue == year));
            }

            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder');
                },
                allowClear: true
            });

            // Initialize star ratings from data-value attributes
            $('.rating-input').each(function() {
                const savedValue = parseInt($(this).attr('data-value'));
                if (!isNaN(savedValue) && savedValue > 0) {
                    const $input = $(this);
                    const $ratingContainer = $input.siblings('.star-rating');
                    const $stars = $ratingContainer.find('.star');
                    const $ratingValue = $input.parent().find('.rating-value');

                    // Set hidden input value
                    $input.val(savedValue);
                    $input.attr('data-original-value', savedValue);

                    // Fill stars
                    $stars.each(function() {
                        if ($(this).data('value') <= savedValue) {
                            $(this).addClass('filled');
                        }
                    });

                    // Update badge
                    $ratingValue.text(savedValue + '/5');
                    updateBadgeColor($ratingValue, savedValue);
                }
            });

            // Calculate initial average
            calculateAverage();

            // Form validation
            const form = document.getElementById('formPenilaian');

            // Bootstrap form validation
            form.addEventListener('submit', function(event) {
                let isValid = true;

                // Validate Select2 fields
                $('.select2').each(function() {
                    const $select = $(this);
                    const $container = $select.next('.select2-container');

                    if (!$select.val() || $select.val() === '') {
                        isValid = false;
                        $container.addClass('is-invalid');
                        $select.addClass('is-invalid');
                    } else {
                        $container.removeClass('is-invalid');
                        $select.removeClass('is-invalid');
                    }
                });

                // Validate star ratings
                let allRated = true;
                $('.rating-input').each(function() {
                    const val = $(this).val();
                    if (!val || val === '' || val === '0') {
                        allRated = false;
                    }
                });

                if (!allRated) {
                    $('#ratingError').show();
                    isValid = false;
                } else {
                    $('#ratingError').hide();
                }

                // Check native form validation
                if (!form.checkValidity()) {
                    isValid = false;
                }

                if (!isValid) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                form.classList.add('was-validated');
            }, false);

            // Remove validation error on Select2 change
            $('.select2').on('change', function() {
                const $select = $(this);
                const $container = $select.next('.select2-container');

                if ($select.val() && $select.val() !== '') {
                    $container.removeClass('is-invalid');
                    $select.removeClass('is-invalid');
                }
            });

            // Reset form to original values
            $('button[type="reset"]').on('click', function(e) {
                e.preventDefault();

                form.classList.remove('was-validated');
                $('.select2-container').removeClass('is-invalid');
                $('.select2').removeClass('is-invalid');

                // Reset bulan
                if (bulanValue) {
                    $('#bulan').val(bulanValue);
                } else {
                    $('#bulan').val('');
                }

                // Reset tahun
                if (tahunValue) {
                    $('#tahun').val(tahunValue);
                } else {
                    $('#tahun').val('');
                }

                // Reset Select2 to trigger change
                $('.select2').trigger('change');

                // Reset star ratings to original values
                $('.rating-input').each(function() {
                    const savedValue = parseInt($(this).attr('data-original-value'));
                    const $input = $(this);
                    const $ratingContainer = $input.siblings('.star-rating');
                    const $stars = $ratingContainer.find('.star');
                    const $ratingValue = $input.parent().find('.rating-value');

                    if (!isNaN(savedValue) && savedValue > 0) {
                        $input.val(savedValue);
                        $stars.each(function() {
                            if ($(this).data('value') <= savedValue) {
                                $(this).addClass('filled');
                            } else {
                                $(this).removeClass('filled');
                            }
                        });
                        $ratingValue.text(savedValue + '/5');
                        updateBadgeColor($ratingValue, savedValue);
                    } else {
                        $input.val('');
                        $stars.removeClass('filled');
                        $ratingValue.text('0/5').removeClass('bg-success bg-primary bg-info bg-warning bg-danger').addClass('bg-secondary');
                    }
                });

                calculateAverage();
                $('#ratingError').hide();
            });

            // Star Rating Functionality
            $('.star-rating').each(function() {
                const $ratingContainer = $(this);
                const $stars = $ratingContainer.find('.star');
                const $hiddenInput = $ratingContainer.siblings('.rating-input');
                const $ratingValue = $ratingContainer.parent().find('.rating-value');

                // Click event
                $stars.on('click', function() {
                    const value = $(this).data('value');
                    $hiddenInput.val(value);

                    // Update stars visual
                    $stars.each(function() {
                        if ($(this).data('value') <= value) {
                            $(this).addClass('filled');
                        } else {
                            $(this).removeClass('filled');
                        }
                    });

                    // Update badge
                    $ratingValue.text(value + '/5');
                    updateBadgeColor($ratingValue, value);

                    // Calculate average
                    calculateAverage();

                    // Hide rating error if all rated
                    let allRated = true;
                    $('.rating-input').each(function() {
                        if (!$(this).val() || $(this).val() === '0') {
                            allRated = false;
                        }
                    });
                    if (allRated) {
                        $('#ratingError').hide();
                    }
                });

                // Hover effect
                $stars.on('mouseenter', function() {
                    const value = $(this).data('value');
                    $stars.each(function() {
                        if ($(this).data('value') <= value) {
                            $(this).addClass('hover');
                        } else {
                            $(this).removeClass('hover');
                        }
                    });
                });

                $ratingContainer.on('mouseleave', function() {
                    $stars.removeClass('hover');
                });
            });

            // Update badge color based on rating
            function updateBadgeColor($badge, value) {
                $badge.removeClass('bg-secondary bg-success bg-primary bg-info bg-warning bg-danger');
                if (value >= 5) {
                    $badge.addClass('bg-success');
                } else if (value >= 4) {
                    $badge.addClass('bg-primary');
                } else if (value >= 3) {
                    $badge.addClass('bg-info');
                } else if (value >= 2) {
                    $badge.addClass('bg-warning');
                } else if (value >= 1) {
                    $badge.addClass('bg-danger');
                } else {
                    $badge.addClass('bg-secondary');
                }
            }

            // Calculate average rating
            function calculateAverage() {
                let total = 0;
                let count = 0;

                $('.rating-input').each(function() {
                    const val = parseInt($(this).val());
                    if (!isNaN(val) && val > 0) {
                        total += val;
                        count++;
                    }
                });

                const average = count > 0 ? (total / count).toFixed(1) : 0.0;
                $('#averageRating').text(average + ' / 5.0');
            }
        });
    </script>
</th:block>

</html>