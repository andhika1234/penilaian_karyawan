<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/master}">
<head>
    <title>Edit Karyawan</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
        }
        .progress-soft {
            background-color: rgba(0,0,0,0.05);
        }
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .gap-2 {
            gap: 0.5rem;
        }
        /* Select2 validation styling */
        .select2-container.is-invalid .select2-selection {
            border-color: #dc3545 !important;
        }
        .select2-container--bootstrap-5 .select2-selection--single {
            padding: 0.375rem 0.75rem;
        }
    </style>
</head>

<th:block layout:fragment="content">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <a th:href="@{/karyawan}" class="btn btn-secondary">
                        <i class="ti ti-arrow-left me-1"></i>
                        Kembali
                    </a>
                </div>
                <h4 class="page-title">Edit Karyawan</h4>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title mb-4">Form Data Karyawan</h4>

                    <form id="formKaryawan" th:action="@{/karyawan/update/{id}(id=${karyawan.id})}" th:object="${karyawan}" method="post" novalidate>
                        <div class="row">
                            <!-- Nama Karyawan -->
                            <div class="col-md-12 mb-3">
                                <label for="namaKaryawan" class="form-label">Nama Karyawan <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="namaKaryawan"
                                       th:field="*{namaKaryawan}"
                                       placeholder="Masukkan nama lengkap karyawan">
                                <div class="invalid-feedback">
                                    Nama karyawan wajib diisi
                                </div>
                            </div>

                            <!-- NIK -->
                            <div class="col-md-6 mb-3">
                                <label for="nik" class="form-label">NIK <span class="text-danger">*</span></label>
                                <input type="text"
                                       class="form-control"
                                       id="nik"
                                       th:field="*{nik}"
                                       placeholder="Nomor Induk Kependudukan (16 digit)"
                                       maxlength="16">
                                <div class="invalid-feedback">
                                    NIK harus 16 digit angka
                                </div>
                            </div>

                            <!-- Nomor Telepon -->
                            <div class="col-md-6 mb-3">
                                <label for="nomorTelepon" class="form-label">Nomor Telepon <span class="text-danger">*</span></label>
                                <input type="tel"
                                       class="form-control"
                                       id="nomorTelepon"
                                       th:field="*{nomorTelepon}"
                                       placeholder="081234567890">
                                <div class="invalid-feedback">
                                    Nomor telepon harus 10-13 digit angka
                                </div>
                            </div>

                            <!-- Email Karyawan -->
                            <div class="col-md-12 mb-3">
                                <label for="emailKaryawan" class="form-label">Email Karyawan <span class="text-danger">*</span></label>
                                <input type="email"
                                       class="form-control"
                                       id="emailKaryawan"
                                       th:field="*{emailKaryawan}"
                                       placeholder="nama.karyawan@company.com">
                                <div class="invalid-feedback">
                                    Email harus valid
                                </div>
                            </div>

                            <!-- Pilih Divisi -->
                            <div class="col-md-6 mb-3">
                                <label for="divisiId" class="form-label">Divisi <span class="text-danger">*</span></label>
                                <select class="form-control select2"
                                        id="divisiId"
                                        name="divisiId"
                                        data-placeholder="Pilih Divisi"
                                        required>
                                    <option value=""></option>
                                    <option th:each="divisi : ${divisiList}"
                                            th:value="${divisi.id}"
                                            th:text="${divisi.namaDivisi}"
                                            th:selected="${karyawan.divisi != null && karyawan.divisi.id == divisi.id}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Divisi wajib dipilih
                                </div>
                            </div>

                            <!-- Pilih Jabatan -->
                            <div class="col-md-6 mb-3">
                                <label for="jabatanId" class="form-label">Jabatan <span class="text-danger">*</span></label>
                                <select class="form-control select2"
                                        id="jabatanId"
                                        name="jabatanId"
                                        data-placeholder="Pilih Jabatan"
                                        required>
                                    <option value=""></option>
                                    <option th:each="jabatan : ${jabatanList}"
                                            th:value="${jabatan.id}"
                                            th:text="${jabatan.namaJabatan}"
                                            th:selected="${karyawan.jabatan != null && karyawan.jabatan.id == jabatan.id}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Jabatan wajib dipilih
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a th:href="@{/karyawan}" class="btn btn-secondary">
                                        <i class="ti ti-x me-1"></i>
                                        Batal
                                    </a>
                                    <button type="reset" class="btn btn-warning" id="btnReset">
                                        <i class="ti ti-refresh me-1"></i>
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="btnSubmit">
                                        <i class="ti ti-device-floppy me-1"></i>
                                        Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="page_js">
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="none">
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: function() {
                    return $(this).data('placeholder');
                },
                allowClear: true
            });

            // Form validation
            const form = document.getElementById('formKaryawan');
            const btnSubmit = document.getElementById('btnSubmit');
            const btnReset = document.getElementById('btnReset');

            // Store original values for reset
            const originalValues = {
                namaKaryawan: $('#namaKaryawan').val(),
                nik: $('#nik').val(),
                nomorTelepon: $('#nomorTelepon').val(),
                emailKaryawan: $('#emailKaryawan').val(),
                divisiId: $('#divisiId').val(),
                jabatanId: $('#jabatanId').val()
            };

            // NIK validation - only numbers, max 16 digits
            $('#nik').on('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '').substring(0, 16);
            });

            // Phone validation - only numbers, max 13 digits
            $('#nomorTelepon').on('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '').substring(0, 13);
            });

            // Custom validation function
            function validateForm() {
                let isValid = true;
                const errors = [];

                // Validate Nama Karyawan
                const nama = $('#namaKaryawan').val().trim();
                if (nama === '') {
                    $('#namaKaryawan').addClass('is-invalid');
                    isValid = false;
                    errors.push('Nama karyawan wajib diisi');
                } else {
                    $('#namaKaryawan').removeClass('is-invalid');
                }

                // Validate NIK
                const nik = $('#nik').val().trim();
                if (nik === '' || nik.length !== 16) {
                    $('#nik').addClass('is-invalid');
                    isValid = false;
                    errors.push('NIK harus 16 digit angka');
                } else {
                    $('#nik').removeClass('is-invalid');
                }

                // Validate Nomor Telepon
                const phone = $('#nomorTelepon').val().trim();
                if (phone === '' || phone.length < 10 || phone.length > 13) {
                    $('#nomorTelepon').addClass('is-invalid');
                    isValid = false;
                    errors.push('Nomor telepon harus 10-13 digit');
                } else {
                    $('#nomorTelepon').removeClass('is-invalid');
                }

                // Validate Email
                const email = $('#emailKaryawan').val().trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email === '' || !emailRegex.test(email)) {
                    $('#emailKaryawan').addClass('is-invalid');
                    isValid = false;
                    errors.push('Email harus valid');
                } else {
                    $('#emailKaryawan').removeClass('is-invalid');
                }

                // Validate Divisi
                const divisiId = $('#divisiId').val();
                if (!divisiId || divisiId === '') {
                    $('#divisiId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                    errors.push('Divisi wajib dipilih');
                } else {
                    $('#divisiId').next('.select2-container').removeClass('is-invalid');
                }

                // Validate Jabatan
                const jabatanId = $('#jabatanId').val();
                if (!jabatanId || jabatanId === '') {
                    $('#jabatanId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                    errors.push('Jabatan wajib dipilih');
                } else {
                    $('#jabatanId').next('.select2-container').removeClass('is-invalid');
                }

                return {isValid, errors};
            }

            // Form submit
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                event.stopPropagation();

                const validation = validateForm();

                if (validation.isValid) {
                    // Disable submit button to prevent double submission
                    btnSubmit.disabled = true;
                    btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Mengupdate...';

                    // Submit form
                    form.submit();
                } else {
                    // Show first error
                    alert('Mohon lengkapi form dengan benar:\n' + validation.errors.join('\n'));
                }

                form.classList.add('was-validated');
            });

            // Remove validation error on input change
            $('#namaKaryawan, #nik, #nomorTelepon, #emailKaryawan').on('input', function() {
                if ($(this).val().trim() !== '') {
                    $(this).removeClass('is-invalid');
                }
            });

            // Remove validation error on Select2 change
            $('.select2').on('change', function() {
                if ($(this).val()) {
                    $(this).next('.select2-container').removeClass('is-invalid');
                }
            });

            // Reset form to original values
            btnReset.addEventListener('click', function(e) {
                e.preventDefault();

                // Reset to original values
                $('#namaKaryawan').val(originalValues.namaKaryawan);
                $('#nik').val(originalValues.nik);
                $('#nomorTelepon').val(originalValues.nomorTelepon);
                $('#emailKaryawan').val(originalValues.emailKaryawan);
                $('#divisiId').val(originalValues.divisiId).trigger('change');
                $('#jabatanId').val(originalValues.jabatanId).trigger('change');

                // Remove validation classes
                form.classList.remove('was-validated');
                $('.select2-container').removeClass('is-invalid');
                $('.form-control').removeClass('is-invalid');

                // Re-enable submit button
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="ti ti-device-floppy me-1"></i>Update';
            });
        });
    </script>
</th:block>

</html>